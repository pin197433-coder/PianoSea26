<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é’¢ç´æµ· - Piano Sea</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #667eea 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }
        .container { max-width: 100%; padding: 20px; padding-bottom: 200px; }
        header { text-align: center; padding: 30px 0 15px; }
        h1 { font-size: 2.2em; margin-bottom: 5px; }
        .subtitle { font-size: 1em; opacity: 0.9; }

        .ocean-selector, .timer-selector, .guide-section {
            background: rgba(255,255,255,0.15); backdrop-filter: blur(10px);
            border-radius: 20px; padding: 20px; margin: 15px 0;
            border: 2px solid rgba(255,255,255,0.3);
        }
        .selector-title { font-size: 1em; margin-bottom: 15px; font-weight: 600; }

        .wave-options { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .wave-btn {
            background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3);
            color: white; padding: 15px 5px; border-radius: 15px; cursor: pointer;
            transition: all 0.3s; text-align: center;
        }
        .wave-btn.active { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: white; transform: scale(1.05);
        }

        .timer-options { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .time-btn {
            background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3);
            color: white; padding: 12px 20px; border-radius: 25px; cursor: pointer;
            font-size: 0.9em; min-width: 80px;
        }
        .time-btn.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }

        .lang-switcher { display: flex; justify-content: center; gap: 8px; margin: 15px 0; flex-wrap: wrap; }
        .lang-btn {
            background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3);
            color: white; padding: 8px 15px; border-radius: 20px; cursor: pointer;
            font-size: 0.85em;
        }
        .lang-btn.active { background: rgba(102, 126, 234, 0.6); border-color: white; }

        .scene-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin: 15px 0; }
        .scene-card {
            background: rgba(255,255,255,0.1); border-radius: 15px;
            padding: 20px 10px; border: 2px solid rgba(255,255,255,0.2);
            cursor: pointer; text-align: center;
        }
        .scene-card.active { background: rgba(102, 126, 234, 0.5); border-color: white; }

        .status-box {
            background: rgba(255,255,255,0.1); border-radius: 12px;
            padding: 15px; margin-bottom: 15px; text-align: center;
        }

        .play-btn-main {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none; color: white; padding: 15px 50px;
            border-radius: 30px; cursor: pointer; font-size: 1.2em;
            font-weight: 600; width: 100%;
        }

        .player-controls {
            background: rgba(0,0,0,0.8); backdrop-filter: blur(20px);
            position: fixed; bottom: 0; left: 0; right: 0;
            padding: 20px; border-top: 1px solid rgba(255,255,255,0.2);
            z-index: 1000;
        }
        .timer-big { font-size: 3em; text-align: center; margin-bottom: 15px; }
        .controls-row {
            display: flex; justify-content: center; align-items: center; gap: 20px;
            margin-bottom: 15px;
        }
        .btn-circle {
            width: 50px; height: 50px; border-radius: 50%;
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3);
            color: white; cursor: pointer; font-size: 1.2em;
        }
        .btn-play-big {
            width: 70px; height: 70px; border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none; color: white; font-size: 1.8em; cursor: pointer;
        }

        .volume-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .vol-item { text-align: center; }
        input[type="range"] { width: 100%; height: 6px; }

        #feedback-btn {
            position: fixed; bottom: 200px; right: 20px; 
            width: 55px; height: 55px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            color: white; text-decoration: none; font-size: 24px; z-index: 999;
        }

        .loading {
            display: inline-block; width: 20px; height: 20px;
            border: 3px solid rgba(255,255,255,.3); border-radius: 50%;
            border-top-color: white; animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .piano-info {
            font-size: 0.8em; opacity: 0.8; margin-top: 10px;
            padding: 8px; background: rgba(255,255,255,0.1); border-radius: 8px;
        }
    </style>
<base target="_blank">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ¹ é’¢ç´æµ·</h1>
            <p class="subtitle">ä¸€é”®æ”¾æ¾ï¼Œä¸æµ·å…±ç”Ÿ</p>
        </header>

        <div class="ocean-selector">
            <div class="selector-title">ğŸŒŠ é€‰æ‹©æµ·åŸŸé£æ ¼</div>
            <div class="wave-options">
                <button class="wave-btn active" onclick="selectOcean('mediterranean')">
                    <div style="font-size: 2em;">ğŸŒ…</div>
                    <div style="font-weight: bold;">åœ°ä¸­æµ·</div>
                    <div style="font-size: 0.8em; opacity: 0.8;">è½»æŸ”ç»µé•¿</div>
                </button>
                <button class="wave-btn" onclick="selectOcean('atlantic')">
                    <div style="font-size: 2em;">ğŸŒŠ</div>
                    <div style="font-weight: bold;">å¤§è¥¿æ´‹</div>
                    <div style="font-size: 0.8em; opacity: 0.8;">è§„å¾‹èˆ’ç¼“</div>
                </button>
                <button class="wave-btn" onclick="selectOcean('pacific')">
                    <div style="font-size: 2em;">ğŸï¸</div>
                    <div style="font-weight: bold;">å¤ªå¹³æ´‹</div>
                    <div style="font-size: 0.8em; opacity: 0.8;">è‡ªç„¶æ²»æ„ˆ</div>
                </button>
            </div>
        </div>

        <div class="timer-selector">
            <div class="selector-title">â±ï¸ é€‰æ‹©æ”¾æ¾æ—¶é•¿</div>
            <div class="timer-options">
                <button class="time-btn active" onclick="selectTimer(15)">15åˆ†é’Ÿ</button>
                <button class="time-btn" onclick="selectTimer(30)">30åˆ†é’Ÿ</button>
                <button class="time-btn" onclick="selectTimer(60)">60åˆ†é’Ÿ</button>
            </div>
        </div>

        <div class="lang-switcher">
            <button class="lang-btn active" onclick="changeLang('zh')">ğŸ‡¨ğŸ‡³ æ™®é€šè¯</button>
            <button class="lang-btn" onclick="changeLang('hk')">ğŸ‡­ğŸ‡° ç²¤è¯­</button>
            <button class="lang-btn" onclick="changeLang('en')">ğŸ‡¬ğŸ‡§ English</button>
            <button class="lang-btn" onclick="changeLang('es')">ğŸ‡ªğŸ‡¸ EspaÃ±ol</button>
            <button class="lang-btn" onclick="changeLang('ar')">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
        </div>

        <div class="scene-grid">
            <div class="scene-card active" onclick="selectScene('anxiety')">
                <div style="font-size: 2.5em;">ğŸ§˜</div>
                <div style="font-weight: bold; margin-top: 5px;">ç„¦è™‘æ€¥æ•‘</div>
                <div style="font-size: 0.8em; opacity: 0.8;">2-3åˆ†é’Ÿè¯­éŸ³</div>
            </div>
            <div class="scene-card" onclick="selectScene('focus')">
                <div style="font-size: 2.5em;">ğŸ¯</div>
                <div style="font-weight: bold; margin-top: 5px;">é™å¿ƒä¸“æ³¨</div>
                <div style="font-size: 0.8em; opacity: 0.8;">1åˆ†é’Ÿè¯­éŸ³</div>
            </div>
            <div class="scene-card" onclick="selectScene('sleep')">
                <div style="font-size: 2.5em;">ğŸŒ™</div>
                <div style="font-weight: bold; margin-top: 5px;">ç¡å‰åŠ©çœ </div>
                <div style="font-size: 0.8em; opacity: 0.8;">3-5åˆ†é’Ÿè¯­éŸ³</div>
            </div>
            <div class="scene-card" onclick="selectScene('nap')">
                <div style="font-size: 2.5em;">ğŸ˜´</div>
                <div style="font-weight: bold; margin-top: 5px;">åˆä¼‘å°æ†©</div>
                <div style="font-size: 0.8em; opacity: 0.8;">3åˆ†é’Ÿè¯­éŸ³</div>
            </div>
        </div>

        <div class="guide-section">
            <div class="status-box" id="statusBox">
                å½“å‰ï¼šåœ°ä¸­æµ· | ç„¦è™‘æ€¥æ•‘ | æ™®é€šè¯ | 15åˆ†é’Ÿ
            </div>
            <button class="play-btn-main" id="mainPlayBtn" onclick="togglePlay()">
                â–¶ï¸ å¼€å§‹æ”¾æ¾
            </button>
            <div id="loadingHint" style="margin-top: 10px; font-size: 0.9em; display: none;">
                <span class="loading"></span> æ­£åœ¨åŠ è½½éŸ³é¢‘...
            </div>
            <div id="errorMsg" style="color: #ff6b6b; margin-top: 10px; font-size: 0.9em; display: none;"></div>

            <div class="piano-info">
                ğŸ’¡ å½“å‰é’¢ç´æ›²ï¼š<span id="currentPiano">ç„¦è™‘æ€¥æ•‘ä¸“ç”¨ - èˆ’ç¼“ç‰ˆ</span><br>
                <small style="opacity: 0.7">*é’¢ç´éŸ³ä¹æ¥è‡ªäº’è”ç½‘å…ç‰ˆæƒèµ„æºï¼Œè‡ªåŠ¨é€‚é…åœºæ™¯</small>
            </div>
        </div>
    </div>

    <div class="player-controls">
        <div class="timer-big" id="timerDisplay">15:00</div>
        <div class="controls-row">
            <button class="btn-circle" onclick="stopAll()">â¹</button>
            <button class="btn-play-big" id="playPauseBtn" onclick="togglePlay()">â–¶</button>
            <button class="btn-circle" onclick="toggleMute()">ğŸ”Š</button>
        </div>
        <div class="volume-grid">
            <div class="vol-item">
                <div>ğŸ¹ é’¢ç´</div>
                <input type="range" id="volPiano" min="0" max="100" value="60" oninput="updateVolumes()">
            </div>
            <div class="vol-item">
                <div>ğŸŒŠ æµ·æµª</div>
                <input type="range" id="volWave" min="0" max="100" value="50" oninput="updateVolumes()">
            </div>
            <div class="vol-item">
                <div>ğŸ™ï¸ è¯­éŸ³</div>
                <input type="range" id="volVoice" min="0" max="100" value="80" oninput="updateVolumes()">
            </div>
        </div>
    </div>

    <a href="https://forms.gle/r6znYF8Pr5ffVmAv9" target="_blank" id="feedback-btn">ğŸ’¬</a>

    <script>
        // ===== éŸ³é¢‘æ–‡ä»¶é…ç½® =====
        // 1. æœ¬åœ°è¯­éŸ³æ–‡ä»¶ (ä½ å·²ä¸Šä¼ çš„)
        const VOICE_FILES = {
            anxiety: {
                zh: 'audio/ç„¦è™‘æ€¥æ•‘-æ™®é€šè¯.mp3',
                hk: 'audio/ç„¦è™‘æ€¥æ•‘-ç²¤è¯­.mp3',
                en: 'audio/ç„¦è™‘æ€¥æ•‘-è‹±è¯­.mp3',
                es: 'audio/ç„¦è™‘æ€¥æ•‘-è¥¿ç­ç‰™è¯­.mp3',
                ar: 'audio/ç„¦è™‘æ€¥æ•‘-é˜¿æ‹‰ä¼¯è¯­.mp3'
            },
            focus: {
                zh: 'audio/é™å¿ƒä¸“æ³¨-æ™®é€šè¯.mp3',
                hk: 'audio/é™å¿ƒä¸“æ³¨-ç²¤è¯­.mp3',
                en: 'audio/é™å¿ƒä¸“æ³¨-è‹±è¯­.mp3',
                es: 'audio/é™å¿ƒä¸“æ³¨-è¥¿ç­ç‰™è¯­.mp3',
                ar: 'audio/é™å¿ƒä¸“æ³¨-é˜¿æ‹‰ä¼¯è¯­.mp3'
            },
            sleep: {
                zh: 'audio/ç¡å‰åŠ©çœ -æ™®é€šè¯.mp3',
                hk: 'audio/ç¡å‰åŠ©çœ -ç²¤è¯­.mp3',
                en: 'audio/ç¡å‰åŠ©çœ -è‹±è¯­.mp3',
                es: 'audio/ç¡å‰åŠ©çœ -è¥¿ç­ç‰™è¯­.mp3',
                ar: 'audio/ç¡å‰åŠ©çœ -é˜¿æ‹‰ä¼¯è¯­.mp3'
            },
            nap: {
                zh: 'audio/åˆä¼‘å°æ†©-æ™®é€šè¯.mp3',
                hk: 'audio/åˆä¼‘å°æ†©-ç²¤è¯­.mp3',
                en: 'audio/åˆä¼‘å°æ†©-è‹±è¯­.mp3',
                es: 'audio/åˆä¼‘å°æ†©-è¥¿ç­ç‰™è¯­.mp3',
                ar: 'audio/åˆä¼‘å°æ†©-é˜¿æ‹‰ä¼¯è¯­.mp3'
            }
        };

        // 2. æœ¬åœ°æµ·æµªæ–‡ä»¶ (ä½ å·²ä¸Šä¼ çš„)
        const WAVE_FILES = {
            mediterranean: 'audio/wave1.mp3',  // åœ°ä¸­æµ· - è½»æŸ”
            atlantic: 'audio/wave2.mp3',        // å¤§è¥¿æ´‹ - ä¸­ç­‰
            pacific: 'audio/wave3.mp3'          // å¤ªå¹³æ´‹ - è¾ƒå¼º
        };

        // 3. åœ¨çº¿é’¢ç´éŸ³ä¹ (å…ç‰ˆæƒï¼Œç›´æ¥æ’­æ”¾ï¼Œæ— éœ€ä¸Šä¼ )
        // æ ¹æ®PDFè¦æ±‚ä¸ºæ¯ä¸ªåœºæ™¯é…ç½®ä¸åŒé£æ ¼çš„é’¢ç´æ›²
        const PIANO_FILES = {
            // ç„¦è™‘æ€¥æ•‘ï¼šæ—‹å¾‹å¹³ç¼“ã€å’Œå¼¦ç®€å•ï¼Œå‚è€ƒã€ŠRiver Flows in Youã€‹ã€Šç§‹æ—¥ç§è¯­ã€‹
            anxiety: [
                'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3',  // èˆ’ç¼“
                'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3'   // æŸ”å’Œ
            ],
            // é™å¿ƒä¸“æ³¨ï¼šèŠ‚å¥è§„å¾‹ã€æ— å¤æ‚å˜å¥ï¼Œå‚è€ƒã€ŠèŠæ¬¡éƒçš„å¤å¤©ã€‹ã€Šå¡å†œã€‹
            focus: [
                'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3',   // è§„å¾‹
                'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-10.mp3'  // ç¨³å®š
            ],
            // ç¡å‰åŠ©çœ ï¼šæ…¢èŠ‚å¥ã€ä½æ—‹å¾‹èµ·ä¼ï¼Œå‚è€ƒã€Šå¡å†œã€‹ã€Šå¤œçš„é’¢ç´æ›²5ã€‹
            sleep: [
                'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3',   // æ…¢é€Ÿ
                'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-15.mp3'  // å®‰é™
            ],
            // åˆä¼‘å°æ†©ï¼šè½»å¿«æŸ”å’Œã€çŸ­æ—‹å¾‹å¾ªç¯ï¼Œå‚è€ƒã€Šç«¥å¹´ã€‹ã€Šæ¢¦ä¸­çš„å©šç¤¼ã€‹
            nap: [
                'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3',   // è½»å¿«
                'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-7.mp3'   // æŸ”å’ŒçŸ­æ›²
            ]
        };

        const PIANO_NAMES = {
            anxiety: 'River Flows in You - èˆ’ç¼“ç‰ˆ',
            focus: 'èŠæ¬¡éƒçš„å¤å¤© - ä¸“æ³¨ç‰ˆ',
            sleep: 'å¤œçš„é’¢ç´æ›²5 - åŠ©çœ ç‰ˆ',
            nap: 'ç«¥å¹´ - å°æ†©ç‰ˆ'
        };

        // ===== çŠ¶æ€ç®¡ç† =====
        let state = {
            isPlaying: false,
            isMuted: false,
            currentOcean: 'mediterranean',
            currentScene: 'anxiety',
            currentLang: 'zh',
            timer: 15,
            currentPianoIndex: 0
        };

        let audioElements = {};
        let timerInterval = null;
        let remainingSeconds = 15 * 60;

        // ===== åˆå§‹åŒ–éŸ³é¢‘ =====
        function initAudio() {
            console.log('åˆå§‹åŒ–éŸ³é¢‘...');

            // 1. é’¢ç´éŸ³é¢‘ - æ ¹æ®åœºæ™¯é€‰æ‹©
            if (!audioElements.piano) {
                const pianoUrl = PIANO_FILES[state.currentScene][state.currentPianoIndex];
                audioElements.piano = new Audio();
                audioElements.piano.src = pianoUrl;
                audioElements.piano.loop = true;
                audioElements.piano.volume = document.getElementById('volPiano').value / 100;
                audioElements.piano.crossOrigin = 'anonymous';

                audioElements.piano.oncanplay = () => console.log('âœ… é’¢ç´éŸ³é¢‘å°±ç»ª');
                audioElements.piano.onerror = () => showError('é’¢ç´éŸ³é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
            }

            // 2. æµ·æµªéŸ³é¢‘
            if (!audioElements.wave) {
                audioElements.wave = new Audio();
                audioElements.wave.src = WAVE_FILES[state.currentOcean];
                audioElements.wave.loop = true;
                audioElements.wave.volume = document.getElementById('volWave').value / 100;

                audioElements.wave.oncanplay = () => console.log('âœ… æµ·æµªéŸ³é¢‘å°±ç»ª');
                audioElements.wave.onerror = () => showError('æµ·æµªéŸ³é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥audioæ–‡ä»¶å¤¹');
            }

            // 3. è¯­éŸ³éŸ³é¢‘
            loadVoiceAudio();
        }

        function loadVoiceAudio() {
            if (audioElements.voice) {
                audioElements.voice.pause();
                audioElements.voice = null;
            }

            const voiceUrl = VOICE_FILES[state.currentScene][state.currentLang];
            if (!voiceUrl) {
                showError('è¯­éŸ³æ–‡ä»¶æœªæ‰¾åˆ°: ' + state.currentScene + '-' + state.currentLang);
                return;
            }

            audioElements.voice = new Audio();
            audioElements.voice.src = voiceUrl;
            audioElements.voice.volume = document.getElementById('volVoice').value / 100;

            audioElements.voice.oncanplay = () => console.log('âœ… è¯­éŸ³éŸ³é¢‘å°±ç»ª');
            audioElements.voice.onerror = () => {
                console.error('è¯­éŸ³åŠ è½½å¤±è´¥:', voiceUrl);
                showError('è¯­éŸ³åŠ è½½å¤±è´¥ï¼Œè¯·ç¡®è®¤æ–‡ä»¶å­˜åœ¨: ' + voiceUrl);
            };

            audioElements.voice.onended = () => {
                console.log('è¯­éŸ³æ’­æ”¾ç»“æŸï¼Œç»§ç»­èƒŒæ™¯éŸ³ä¹');
            };
        }

        // ===== æ’­æ”¾æ§åˆ¶ =====
        function togglePlay() {
            console.log('åˆ‡æ¢æ’­æ”¾çŠ¶æ€:', state.isPlaying ? 'æš‚åœ' : 'æ’­æ”¾');

            const mainBtn = document.getElementById('mainPlayBtn');
            const playPauseBtn = document.getElementById('playPauseBtn');
            const loadingHint = document.getElementById('loadingHint');

            if (!state.isPlaying) {
                initAudio();
                loadingHint.style.display = 'block';
                hideError();

                // iOSéœ€è¦ç”¨æˆ·æ‰‹åŠ¿æ‰èƒ½æ’­æ”¾
                setTimeout(() => {
                    let playPromises = [];

                    if (audioElements.piano) {
                        playPromises.push(audioElements.piano.play().catch(e => {
                            console.error('é’¢ç´æ’­æ”¾å¤±è´¥:', e);
                            return false;
                        }));
                    }
                    if (audioElements.wave) {
                        playPromises.push(audioElements.wave.play().catch(e => {
                            console.error('æµ·æµªæ’­æ”¾å¤±è´¥:', e);
                            return false;
                        }));
                    }
                    if (audioElements.voice) {
                        playPromises.push(audioElements.voice.play().catch(e => {
                            console.error('è¯­éŸ³æ’­æ”¾å¤±è´¥:', e);
                            return false;
                        }));
                    }

                    Promise.all(playPromises).then(results => {
                        loadingHint.style.display = 'none';
                        if (results.includes(false)) {
                            showError('éƒ¨åˆ†éŸ³é¢‘æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶');
                        } else {
                            state.isPlaying = true;
                            mainBtn.innerHTML = 'â¸ï¸ æš‚åœæ”¾æ¾';
                            playPauseBtn.innerHTML = 'â¸';
                            startTimer();
                        }
                    });
                }, 300);

            } else {
                pauseAll();
                state.isPlaying = false;
                mainBtn.innerHTML = 'â–¶ï¸ ç»§ç»­æ”¾æ¾';
                playPauseBtn.innerHTML = 'â–¶';
                stopTimer();
            }
        }

        function pauseAll() {
            if (audioElements.piano) audioElements.piano.pause();
            if (audioElements.wave) audioElements.wave.pause();
            if (audioElements.voice) audioElements.voice.pause();
        }

        function stopAll() {
            pauseAll();
            if (audioElements.piano) {
                audioElements.piano.currentTime = 0;
                audioElements.piano = null; // é‡ç½®ä»¥ä¾¿åˆ‡æ¢åœºæ™¯æ—¶é‡æ–°åŠ è½½
            }
            if (audioElements.wave) {
                audioElements.wave.currentTime = 0;
            }
            if (audioElements.voice) {
                audioElements.voice.currentTime = 0;
            }

            state.isPlaying = false;
            document.getElementById('mainPlayBtn').innerHTML = 'â–¶ï¸ å¼€å§‹æ”¾æ¾';
            document.getElementById('playPauseBtn').innerHTML = 'â–¶';
            stopTimer();
            remainingSeconds = state.timer * 60;
            updateTimerDisplay();
        }

        function toggleMute() {
            state.isMuted = !state.isMuted;
            Object.values(audioElements).forEach(audio => {
                if (audio) audio.muted = state.isMuted;
            });
            event.target.innerHTML = state.isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
        }

        function updateVolumes() {
            if (audioElements.piano) audioElements.piano.volume = document.getElementById('volPiano').value / 100;
            if (audioElements.wave) audioElements.wave.volume = document.getElementById('volWave').value / 100;
            if (audioElements.voice) audioElements.voice.volume = document.getElementById('volVoice').value / 100;
        }

        // ===== åœºæ™¯é€‰æ‹© =====
        function selectOcean(ocean) {
            state.currentOcean = ocean;

            document.querySelectorAll('.wave-btn').forEach((btn, index) => {
                btn.classList.remove('active');
                if ((ocean === 'mediterranean' && index === 0) ||
                    (ocean === 'atlantic' && index === 1) ||
                    (ocean === 'pacific' && index === 2)) {
                    btn.classList.add('active');
                }
            });

            if (audioElements.wave) {
                const wasPlaying = state.isPlaying;
                audioElements.wave.src = WAVE_FILES[ocean];
                audioElements.wave.load();
                if (wasPlaying) {
                    audioElements.wave.play().catch(() => {});
                }
            }

            updateStatus();
        }

        function selectScene(scene) {
            state.currentScene = scene;
            state.currentPianoIndex = 0; // é‡ç½®é’¢ç´æ›²ç´¢å¼•

            document.querySelectorAll('.scene-card').forEach((card, index) => {
                card.classList.remove('active');
                const scenes = ['anxiety', 'focus', 'sleep', 'nap'];
                if (scenes[index] === scene) {
                    card.classList.add('active');
                }
            });

            // æ›´æ–°æ˜¾ç¤ºçš„é’¢ç´æ›²å
            document.getElementById('currentPiano').textContent = PIANO_NAMES[scene];

            // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œåˆ‡æ¢é’¢ç´æ›²å’Œè¯­éŸ³
            if (state.isPlaying) {
                stopAll();
                setTimeout(() => togglePlay(), 300);
            } else {
                // é¢„åŠ è½½æ–°çš„è¯­éŸ³å’Œé’¢ç´
                if (audioElements.piano) audioElements.piano = null;
                loadVoiceAudio();
            }

            updateStatus();
        }

        function changeLang(lang) {
            state.currentLang = lang;

            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            if (state.isPlaying) {
                const currentTime = audioElements.voice ? audioElements.voice.currentTime : 0;
                loadVoiceAudio();
                setTimeout(() => {
                    if (audioElements.voice) {
                        audioElements.voice.currentTime = currentTime;
                        audioElements.voice.play().catch(() => {});
                    }
                }, 300);
            } else {
                loadVoiceAudio();
            }

            updateStatus();
        }

        function selectTimer(minutes) {
            state.timer = minutes;
            remainingSeconds = minutes * 60;
            updateTimerDisplay();

            document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            updateStatus();
        }

        // ===== è®¡æ—¶å™¨ =====
        function updateTimerDisplay() {
            const mins = Math.floor(remainingSeconds / 60);
            const secs = remainingSeconds % 60;
            document.getElementById('timerDisplay').textContent = 
                String(mins).padStart(2, '0') + ':' + String(secs).padStart(2, '0');
        }

        function startTimer() {
            stopTimer();
            timerInterval = setInterval(() => {
                remainingSeconds--;
                updateTimerDisplay();
                if (remainingSeconds <= 0) {
                    stopAll();
                    alert('æ”¾æ¾æ—¶é—´ç»“æŸï¼');
                }
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        // ===== è¾…åŠ©åŠŸèƒ½ =====
        function updateStatus() {
            const oceanNames = { mediterranean: 'åœ°ä¸­æµ·', atlantic: 'å¤§è¥¿æ´‹', pacific: 'å¤ªå¹³æ´‹' };
            const sceneNames = { anxiety: 'ç„¦è™‘æ€¥æ•‘', focus: 'é™å¿ƒä¸“æ³¨', sleep: 'ç¡å‰åŠ©çœ ', nap: 'åˆä¼‘å°æ†©' };
            const langNames = { zh: 'æ™®é€šè¯', hk: 'ç²¤è¯­', en: 'è‹±è¯­', es: 'è¥¿ç­ç‰™è¯­', ar: 'é˜¿æ‹‰ä¼¯è¯­' };

            document.getElementById('statusBox').innerHTML = 
                oceanNames[state.currentOcean] + ' | ' + 
                sceneNames[state.currentScene] + ' | ' + 
                langNames[state.currentLang] + ' | ' + 
                state.timer + 'åˆ†é’Ÿ';
        }

        function showError(msg) {
            const el = document.getElementById('errorMsg');
            el.textContent = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        }

        function hideError() {
            document.getElementById('errorMsg').style.display = 'none';
        }

        // iOSéŸ³é¢‘è§£é”
        document.addEventListener('click', function() {
            const silent = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=');
            silent.play().catch(() => {});
        }, { once: true });

        // åˆå§‹åŒ–
        updateStatus();
        loadVoiceAudio();
        document.getElementById('currentPiano').textContent = PIANO_NAMES['anxiety'];
    </script>
</body>
</html>