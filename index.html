<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é’¢ç´æµ· - Piano Sea</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #667eea 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
            padding-bottom: 220px;
        }
        .container { max-width: 100%; padding: 20px; }
        header { text-align: center; padding: 20px 0; }
        h1 { font-size: 2em; margin-bottom: 5px; }

        .card {
            background: rgba(255,255,255,0.15);
            border-radius: 15px;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            margin: 5px;
            width: calc(100% - 10px);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 10px 0; }
        .item {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .item.active {
            border-color: white;
            background: rgba(102, 126, 234, 0.5);
        }

        .status {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.9em;
            min-height: 40px;
        }

        .error {
            color: #ff6b6b;
            font-size: 0.85em;
            margin-top: 5px;
        }

        .success {
            color: #4ade80;
            font-size: 0.85em;
            margin-top: 5px;
        }

        .player {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.9);
            padding: 15px;
            z-index: 1000;
        }

        .timer { font-size: 2.5em; text-align: center; margin-bottom: 10px; }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            align-items: center;
            margin-bottom: 10px;
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 1.2em;
            cursor: pointer;
        }

        .play-btn {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-size: 1.5em;
        }

        .volume-container {
            display: flex;
            gap: 10px;
            justify-content: space-around;
        }

        .volume-item {
            flex: 1;
            text-align: center;
        }

        input[type="range"] {
            width: 100%;
            margin-top: 5px;
        }

        .diagnostic {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 0.8em;
            max-height: 150px;
            overflow-y: auto;
        }

        .file-check {
            display: flex;
            justify-content: space-between;
            padding: 5px;
            margin: 3px 0;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
            font-size: 0.85em;
        }

        .file-ok { color: #4ade80; }
        .file-error { color: #ff6b6b; }
    </style>
<base target="_blank">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ¹ é’¢ç´æµ·</h1>
            <p>ä¸€é”®æ”¾æ¾ï¼Œä¸æµ·å…±ç”Ÿ</p>
        </header>

        <div class="card">
            <div style="font-weight: bold; margin-bottom: 10px;">ğŸŒŠ é€‰æ‹©æµ·åŸŸ</div>
            <div class="grid">
                <div class="item active" onclick="setOcean('mediterranean')">åœ°ä¸­æµ·<br><small>è½»æŸ”</small></div>
                <div class="item" onclick="setOcean('atlantic')">å¤§è¥¿æ´‹<br><small>èˆ’ç¼“</small></div>
                <div class="item" onclick="setOcean('pacific')">å¤ªå¹³æ´‹<br><small>æ²»æ„ˆ</small></div>
            </div>
        </div>

        <div class="card">
            <div style="font-weight: bold; margin-bottom: 10px;">ğŸ­ é€‰æ‹©åœºæ™¯</div>
            <div class="grid">
                <div class="item active" onclick="setScene('anxiety')">ç„¦è™‘æ€¥æ•‘</div>
                <div class="item" onclick="setScene('focus')">é™å¿ƒä¸“æ³¨</div>
                <div class="item" onclick="setScene('sleep')">ç¡å‰åŠ©çœ </div>
                <div class="item" onclick="setScene('nap')">åˆä¼‘å°æ†©</div>
            </div>
        </div>

        <div class="card">
            <div style="font-weight: bold; margin-bottom: 10px;">ğŸŒ é€‰æ‹©è¯­è¨€</div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn" style="flex: 1; min-width: 80px;" onclick="setLang('zh')">æ™®é€šè¯</button>
                <button class="btn" style="flex: 1; min-width: 80px;" onclick="setLang('hk')">ç²¤è¯­</button>
                <button class="btn" style="flex: 1; min-width: 80px;" onclick="setLang('en')">English</button>
            </div>
        </div>

        <div class="card">
            <div class="status" id="statusText">å‡†å¤‡å°±ç»ª - ç‚¹å‡»"å¼€å§‹"æ’­æ”¾éŸ³é¢‘</div>
            <div id="errorText" class="error"></div>
            <div id="successText" class="success"></div>

            <button class="btn" id="mainBtn" onclick="togglePlay()" style="margin-top: 10px;">
                â–¶ï¸ å¼€å§‹æ”¾æ¾
            </button>

            <button class="btn" onclick="checkFiles()" style="background: rgba(255,255,255,0.2); margin-top: 10px;">
                ğŸ” æ£€æŸ¥éŸ³é¢‘æ–‡ä»¶
            </button>
        </div>

        <div class="card" id="diagnosticCard" style="display: none;">
            <div style="font-weight: bold; margin-bottom: 10px;">ğŸ“‹ æ–‡ä»¶æ£€æŸ¥æŠ¥å‘Š</div>
            <div id="fileList"></div>
        </div>

        <div class="card">
            <div style="font-weight: bold; margin-bottom: 10px;">ğŸ“ ä½¿ç”¨è¯´æ˜</div>
            <div style="font-size: 0.9em; line-height: 1.6;">
                1. ç¡®ä¿å·²ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶åˆ° audio/ æ–‡ä»¶å¤¹<br>
                2. æ–‡ä»¶åå¿…é¡»å®Œå…¨åŒ¹é…ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰<br>
                3. æ”¯æŒçš„æ ¼å¼ï¼šMP3, WAV<br>
                4. å¦‚æœæ— å£°ï¼Œç‚¹å‡»"æ£€æŸ¥éŸ³é¢‘æ–‡ä»¶"æŸ¥çœ‹è¯¦æƒ…
            </div>
        </div>
    </div>

    <div class="player">
        <div class="timer" id="timerDisplay">15:00</div>
        <div class="controls">
            <button class="control-btn" onclick="stopAll()">â¹</button>
            <button class="control-btn play-btn" id="playBtn" onclick="togglePlay()">â–¶</button>
            <button class="control-btn" onclick="toggleMute()">ğŸ”Š</button>
        </div>
        <div class="volume-container">
            <div class="volume-item">
                <div>ğŸ¹ é’¢ç´</div>
                <input type="range" id="volPiano" min="0" max="100" value="70" oninput="updateVolumes()">
            </div>
            <div class="volume-item">
                <div>ğŸŒŠ æµ·æµª</div>
                <input type="range" id="volWave" min="0" max="100" value="50" oninput="updateVolumes()">
            </div>
            <div class="volume-item">
                <div>ğŸ™ï¸ è¯­éŸ³</div>
                <input type="range" id="volVoice" min="0" max="100" value="80" oninput="updateVolumes()">
            </div>
        </div>
    </div>

    <script>
        // éŸ³é¢‘é…ç½®
        const CONFIG = {
            // ä½¿ç”¨å¯é çš„åœ¨çº¿éŸ³é¢‘ä½œä¸ºå¤‡é€‰
            online: {
                piano: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3',
                wave: 'https://cdn.pixabay.com/download/audio/2022/03/15/audio_c8c8a73467.mp3'
            },
            // æœ¬åœ°æ–‡ä»¶è·¯å¾„
            local: {
                voice: {
                    anxiety: { zh: 'audio/ç„¦è™‘æ€¥æ•‘-æ™®é€šè¯.mp3', hk: 'audio/ç„¦è™‘æ€¥æ•‘-ç²¤è¯­.mp3', en: 'audio/ç„¦è™‘æ€¥æ•‘-è‹±è¯­.mp3' },
                    focus: { zh: 'audio/é™å¿ƒä¸“æ³¨-æ™®é€šè¯.mp3', hk: 'audio/é™å¿ƒä¸“æ³¨-ç²¤è¯­.mp3', en: 'audio/é™å¿ƒä¸“æ³¨-è‹±è¯­.mp3' },
                    sleep: { zh: 'audio/ç¡å‰åŠ©çœ -æ™®é€šè¯.mp3', hk: 'audio/ç¡å‰åŠ©çœ -ç²¤è¯­.mp3', en: 'audio/ç¡å‰åŠ©çœ -è‹±è¯­.mp3' },
                    nap: { zh: 'audio/åˆä¼‘å°æ†©-æ™®é€šè¯.mp3', hk: 'audio/åˆä¼‘å°æ†©-ç²¤è¯­.mp3', en: 'audio/åˆä¼‘å°æ†©-è‹±è¯­.mp3' }
                },
                wave: {
                    mediterranean: 'audio/wave1.mp3',
                    atlantic: 'audio/wave2.mp3',
                    pacific: 'audio/wave3.mp3'
                }
            }
        };

        let state = {
            isPlaying: false,
            isMuted: false,
            ocean: 'mediterranean',
            scene: 'anxiety',
            lang: 'zh',
            useOnlineAudio: false  // å¦‚æœæœ¬åœ°æ–‡ä»¶å¤±è´¥ï¼Œåˆ‡æ¢åˆ°åœ¨çº¿éŸ³é¢‘
        };

        let audio = {};
        let timer = null;
        let remaining = 15 * 60;

        // åˆå§‹åŒ–
        function init() {
            updateStatus();
            // é¢„åŠ è½½æ£€æŸ¥
            setTimeout(checkFiles, 1000);
        }

        // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        function checkFiles() {
            const card = document.getElementById('diagnosticCard');
            const list = document.getElementById('fileList');
            card.style.display = 'block';
            list.innerHTML = '<div>æ­£åœ¨æ£€æŸ¥æ–‡ä»¶...</div>';

            const filesToCheck = [];

            // æ£€æŸ¥æµ·æµªæ–‡ä»¶
            Object.entries(CONFIG.local.wave).forEach(([key, path]) => {
                filesToCheck.push({ name: `æµ·æµª-${key}`, path: path });
            });

            // æ£€æŸ¥è¯­éŸ³æ–‡ä»¶ï¼ˆä»…æ£€æŸ¥å½“å‰åœºæ™¯ï¼‰
            Object.entries(CONFIG.local.voice[state.scene]).forEach(([lang, path]) => {
                filesToCheck.push({ name: `è¯­éŸ³-${lang}`, path: path });
            });

            let results = [];
            let checked = 0;

            filesToCheck.forEach(file => {
                const audioTest = new Audio();
                audioTest.src = file.path;

                audioTest.oncanplay = () => {
                    results.push(`<div class="file-check"><span>${file.name}</span><span class="file-ok">âœ“ æ­£å¸¸</span></div>`);
                    checked++;
                    if (checked === filesToCheck.length) showResults();
                };

                audioTest.onerror = () => {
                    results.push(`<div class="file-check"><span>${file.name}</span><span class="file-error">âœ— ç¼ºå¤±æˆ–æ— æ³•è®¿é—®</span></div>`);
                    checked++;
                    if (checked === filesToCheck.length) showResults();
                };

                // 5ç§’è¶…æ—¶
                setTimeout(() => {
                    if (checked < filesToCheck.length) {
                        results.push(`<div class="file-check"><span>${file.name}</span><span class="file-error">âœ— åŠ è½½è¶…æ—¶</span></div>`);
                        checked++;
                        if (checked === filesToCheck.length) showResults();
                    }
                }, 5000);
            });

            function showResults() {
                list.innerHTML = results.join('');
                const hasErrors = results.some(r => r.includes('file-error'));
                if (hasErrors) {
                    showError('éƒ¨åˆ†æ–‡ä»¶æ£€æŸ¥å¤±è´¥ï¼Œå»ºè®®ä½¿ç”¨åœ¨çº¿éŸ³é¢‘æ¨¡å¼ï¼ˆç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼‰');
                    list.innerHTML += '<button class="btn" onclick="useOnlineMode()" style="margin-top: 10px;">åˆ‡æ¢åˆ°åœ¨çº¿éŸ³é¢‘æ¨¡å¼</button>';
                } else {
                    showSuccess('æ‰€æœ‰æ–‡ä»¶æ£€æŸ¥é€šè¿‡ï¼');
                }
            }
        }

        function useOnlineMode() {
            state.useOnlineAudio = true;
            showSuccess('å·²åˆ‡æ¢åˆ°åœ¨çº¿éŸ³é¢‘æ¨¡å¼ï¼ˆæ— éœ€æœ¬åœ°æ–‡ä»¶ï¼‰');
            updateStatus();
        }

        // æ’­æ”¾æ§åˆ¶
        function togglePlay() {
            if (state.isPlaying) {
                pauseAll();
                state.isPlaying = false;
                updateUI('æš‚åœ');
                clearInterval(timer);
            } else {
                playAll();
            }
        }

        function playAll() {
            showError('');
            showSuccess('æ­£åœ¨åˆå§‹åŒ–éŸ³é¢‘...');

            // ç¡®å®šéŸ³é¢‘æº
            const pianoSrc = state.useOnlineAudio ? CONFIG.online.piano : CONFIG.online.piano; // é’¢ç´ä¸€ç›´ç”¨åœ¨çº¿
            const waveSrc = state.useOnlineAudio ? CONFIG.online.wave : CONFIG.local.wave[state.ocean];
            const voiceSrc = state.useOnlineAudio ? null : CONFIG.local.voice[state.scene][state.lang];

            // åˆ›å»ºéŸ³é¢‘å¯¹è±¡
            if (!audio.piano) {
                audio.piano = new Audio(pianoSrc);
                audio.piano.loop = true;
                audio.piano.volume = document.getElementById('volPiano').value / 100;
                audio.piano.crossOrigin = 'anonymous';
            }

            if (!audio.wave || audio.wave.src !== waveSrc) {
                audio.wave = new Audio(waveSrc);
                audio.wave.loop = true;
                audio.wave.volume = document.getElementById('volWave').value / 100;
            }

            if (!state.useOnlineAudio && voiceSrc) {
                if (!audio.voice || audio.voice.src !== voiceSrc) {
                    audio.voice = new Audio(voiceSrc);
                    audio.voice.volume = document.getElementById('volVoice').value / 100;
                }
            }

            // æ’­æ”¾
            let playCount = 0;
            let errorCount = 0;
            const totalTracks = state.useOnlineAudio ? 2 : 3;

            function checkComplete() {
                playCount++;
                if (playCount + errorCount === totalTracks) {
                    if (errorCount === 0) {
                        state.isPlaying = true;
                        updateUI('æ’­æ”¾ä¸­');
                        showSuccess('éŸ³é¢‘æ’­æ”¾æˆåŠŸï¼');
                        startTimer();
                    } else {
                        showError(`${errorCount}ä¸ªéŸ³é¢‘æ’­æ”¾å¤±è´¥ï¼Œå»ºè®®ç‚¹å‡»"æ£€æŸ¥éŸ³é¢‘æ–‡ä»¶"æŸ¥çœ‹è¯¦æƒ…`);
                    }
                }
            }

            // æ’­æ”¾é’¢ç´
            audio.piano.play().then(() => {
                showSuccess('é’¢ç´éŸ³ä¹æ’­æ”¾æˆåŠŸ');
                checkComplete();
            }).catch(err => {
                console.error('é’¢ç´æ’­æ”¾å¤±è´¥:', err);
                showError('é’¢ç´éŸ³é¢‘æ’­æ”¾å¤±è´¥: ' + err.message);
                errorCount++;
                checkComplete();
            });

            // æ’­æ”¾æµ·æµª
            audio.wave.play().then(() => {
                showSuccess('æµ·æµªå£°éŸ³æ’­æ”¾æˆåŠŸ');
                checkComplete();
            }).catch(err => {
                console.error('æµ·æµªæ’­æ”¾å¤±è´¥:', err);
                showError('æµ·æµªéŸ³é¢‘æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶: ' + waveSrc);
                errorCount++;
                checkComplete();
            });

            // æ’­æ”¾è¯­éŸ³ï¼ˆå¦‚æœä½¿ç”¨æœ¬åœ°æ¨¡å¼ï¼‰
            if (!state.useOnlineAudio && audio.voice) {
                audio.voice.play().then(() => {
                    showSuccess('è¯­éŸ³æ’­æ”¾æˆåŠŸ');
                    checkComplete();
                }).catch(err => {
                    console.error('è¯­éŸ³æ’­æ”¾å¤±è´¥:', err);
                    showError('è¯­éŸ³æ’­æ”¾å¤±è´¥ï¼Œå»ºè®®åˆ‡æ¢åˆ°åœ¨çº¿æ¨¡å¼');
                    errorCount++;
                    checkComplete();
                });
            }
        }

        function pauseAll() {
            if (audio.piano) audio.piano.pause();
            if (audio.wave) audio.wave.pause();
            if (audio.voice) audio.voice.pause();
        }

        function stopAll() {
            pauseAll();
            if (audio.piano) audio.piano.currentTime = 0;
            if (audio.wave) audio.wave.currentTime = 0;
            if (audio.voice) audio.voice.currentTime = 0;
            state.isPlaying = false;
            remaining = 15 * 60;
            updateTimer();
            updateUI('å·²åœæ­¢');
            clearInterval(timer);
        }

        function toggleMute() {
            state.isMuted = !state.isMuted;
            Object.values(audio).forEach(a => {
                if (a) a.muted = state.isMuted;
            });
        }

        function updateVolumes() {
            if (audio.piano) audio.piano.volume = document.getElementById('volPiano').value / 100;
            if (audio.wave) audio.wave.volume = document.getElementById('volWave').value / 100;
            if (audio.voice) audio.voice.volume = document.getElementById('volVoice').value / 100;
        }

        // åœºæ™¯è®¾ç½®
        function setOcean(ocean) {
            state.ocean = ocean;
            document.querySelectorAll('.item')[0].parentElement.querySelectorAll('.item').forEach((el, i) => {
                el.classList.toggle('active', i === ['mediterranean', 'atlantic', 'pacific'].indexOf(ocean));
            });
            if (state.isPlaying) {
                stopAll();
                setTimeout(playAll, 300);
            }
            updateStatus();
        }

        function setScene(scene) {
            state.scene = scene;
            const scenes = ['anxiety', 'focus', 'sleep', 'nap'];
            document.querySelectorAll('.item')[3].parentElement.querySelectorAll('.item').forEach((el, i) => {
                el.classList.toggle('active', i === scenes.indexOf(scene));
            });
            if (state.isPlaying) {
                stopAll();
                setTimeout(playAll, 300);
            }
            updateStatus();
        }

        function setLang(lang) {
            state.lang = lang;
            if (state.isPlaying && !state.useOnlineAudio) {
                stopAll();
                setTimeout(playAll, 300);
            }
            updateStatus();
        }

        // è®¡æ—¶å™¨
        function startTimer() {
            clearInterval(timer);
            timer = setInterval(() => {
                remaining--;
                updateTimer();
                if (remaining <= 0) {
                    stopAll();
                    alert('æ—¶é—´åˆ°ï¼');
                }
            }, 1000);
        }

        function updateTimer() {
            const m = Math.floor(remaining / 60).toString().padStart(2, '0');
            const s = (remaining % 60).toString().padStart(2, '0');
            document.getElementById('timerDisplay').textContent = `${m}:${s}`;
        }

        // UIæ›´æ–°
        function updateStatus() {
            const names = {
                ocean: { mediterranean: 'åœ°ä¸­æµ·', atlantic: 'å¤§è¥¿æ´‹', pacific: 'å¤ªå¹³æ´‹' },
                scene: { anxiety: 'ç„¦è™‘æ€¥æ•‘', focus: 'é™å¿ƒä¸“æ³¨', sleep: 'ç¡å‰åŠ©çœ ', nap: 'åˆä¼‘å°æ†©' },
                lang: { zh: 'æ™®é€šè¯', hk: 'ç²¤è¯­', en: 'è‹±è¯­' }
            };
            const mode = state.useOnlineAudio ? '[åœ¨çº¿æ¨¡å¼]' : '[æœ¬åœ°æ¨¡å¼]';
            document.getElementById('statusText').textContent = 
                `${mode} ${names.ocean[state.ocean]} | ${names.scene[state.scene]} | ${names.lang[state.lang]}`;
        }

        function updateUI(status) {
            document.getElementById('mainBtn').textContent = state.isPlaying ? 'â¸ï¸ æš‚åœæ”¾æ¾' : 'â–¶ï¸ å¼€å§‹æ”¾æ¾';
            document.getElementById('playBtn').textContent = state.isPlaying ? 'â¸' : 'â–¶';
        }

        function showError(msg) {
            document.getElementById('errorText').textContent = msg;
        }

        function showSuccess(msg) {
            document.getElementById('successText').textContent = msg;
            setTimeout(() => {
                if (document.getElementById('successText').textContent === msg) {
                    document.getElementById('successText').textContent = '';
                }
            }, 3000);
        }

        // å¯åŠ¨
        init();
    </script>
</body>
</html>